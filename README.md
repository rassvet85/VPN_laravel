Идея следующая:
1) На линуксе поднимаем 2 сервака:
- server1 - в будущем возможно будет вебпортал для админов (настройки апи сервера, просмотр логов апи сервера и т.д.). На нем поднимаю также laravel php сервер. На нем поднимаем БД для данных.
- server2 - это VPN сервер на движке Wireguard (наподобие нашего внешнего VPN сервера).
2) Для доступа к нашей сети пользователя - в AD нужно добавить в группу VPN_INTERNAL_USER и прописать в каком-то поле профиля (например в поле Web Page) название компа (компов), к которому(ым) пользователь может получить доступ извне.
3) На server написать php скрипт, который будет отрабатывать каждую минуту (5 минут), проверяя через LDAP список пользователей с группой VPN_INTERNAL_USER.

При появлении нового пользователя в группе:
a) На server2 сформировывается конфиг ВПН для нового пользователя.  При успешном выполнении отмечаем в БД.
б) Скрипт через powershell дает команду на удаленный комп для включения именно этого пользователя в группу удаленных рабочих столов. При успешном выполнении отмечаем в БД.
в) Узнаем текущий IP компа и разрешаем доступ через firewall (iptables) пользователю только исключительно к его компу на предприятии.  При успешном выполнении отмечаем в БД.
г) после полной отработки скрипта по почте (email в профиле AD) отправляем пользователю архив с конфигом wireguard, инсталяхой wireguard, RDP файлом и мануалом по настройке у себя дома.  При успешном выполнении отмечаем в БД.

В случае неудачи какого либо действия (выключен рабочий комп пользака), записываем в БД и в следующую отработку пытаемся вновь выполнить.
На компе пользователя через GPO делаем скрипт, который будет отрабатывать после входа пользака в систему. Если пользователь принадлежит группе VPN_INTERNAL_USER - проверяем на изменение IP компа и в случае изменения обновляем его в БД.
В случае блокировки акка пользователя, либо исключения его из группы VPN_INTERNAL_USER - удаляем все доступы.
При изменении компа пользователя - удаляем локальную группу на старом компе и устанавливаем на новом.

Реализация:
1) На сервере server1 развернут апи сервер на основе nginx и Laravel 9 и создано API для автоматизации корпоративной VPN (/var/www/Portal_laravel). Также в будущем этот сервер будет использоваться в качестве портала для управлением параметров API сервера СКУД, просмотра логов и т.д. С помощью библиотеки gss-ntlmssp (поддержка NTLM авторизации и протокола kerberos) сервер подключен в наш домен. Это необходимо для отработки PS скриптов. Установлена библиотека powershell от Microsoft для Linux. Установлена БД Postgres.
2) На сервере server2 установлен Ubuntu 22.04 и развёрнут Wireguard сервер с порталом управления  h44z /wg-portal. Панель управления: http://server2:8123. Авторизация в Inventory, вкладка VPN. Менять там параметры только в крайнем случае! Фал конфига с параметрами: /app/wireguard-portal/wg-portal.yml
3) В DC прописан dns portal.site.ru lkz для сервера server1.
4) В AD cозданы группы VPN_INTERNAL_USER и VPN_INTERNAL_ADMIN (необходимо быть в ней для управления в админке wireguard).
5) В AD пользователь DOMAIN\ldapexternal с помощью GPO Localadmin and Remoteadmin добавлен в локальные админы на рабочих станциях нашей сети (чтобы удалённо добавлять через PS пользаков в локал группу "user remote desktop".
6) Настроен Firewall на server2 с помощью iptables.
7) Проброшен порт udp 37910 к  server2 для доступа пользователей к корпоративному VPN.
8) Для VPN сети была выбрана подсеть 10.84.0.0/20. На sw0001 настроена маршрутизация к ней.
9) Добавлено GPO VPNinternal для проверки изменения IP рабочих мест пользователей при загрузке системы.
   
Для администраторов:
1) Чтобы у пользователя появился доступ к корпоративной VPN необходимо включить его в группу VPN_INTERNAL_USER, в профиле AD обязательно указать его email, в поле Web page прописать название рабочего места к которому будет подключаться пользователь. Можно указать несколько рабочих мест (1 комп в каждой строке).
2) С помощью CRON на server1 каждую минуту идет запрос к https://portal.site.ru/api/ldaprefresh, которая и обрабатывает изменения параметров в AD. Можно самому вручную в браузере запустить этот адрес. На выходе будет лог обработки.
3) С помощью GPO VPNinternal при включении рабочих машин отправляется запрос https://portal.site.ru/api/ipchange?comp=$comp для проверки изменения IP рабочего места.
4) На server2 в файерволе автоматически устанавливаются разрешающие правила для доступа клиента с VPN к своему компу. Пример:
    -A FORWARD -s 10.84.0.1/32 -d 10.82.132.204/32 -j ACCEPT_TCP_UDP_3389
    -A ACCEPT_TCP_UDP_3389 -p tcp -m tcp --dport 3389 -j ACCEPT
    -A ACCEPT_TCP_UDP_3389 -p udp -m udp --dport 3389 -j ACCEPT
    -A ACCEPT_TCP_UDP_3389 -p icmp -m icmp --icmp-type any -j ACCEPT

В случае отключения в AD разрешенных компов, либо группы пользователя - происходит удаление этих правил.

Также в server2 активированы разрешающие правила к 10.0.2.0/30 для DNS, NTLM проверки и проверки kerberos удаленного рабочего места.

-A FORWARD -s 10.84.0.0/20 -d 10.0.2.0/30 -p udp -m udp --dport 53 -j ACCEPT
-A FORWARD -s 10.84.0.0/20 -d 10.0.2.0/30 -p tcp -m tcp --dport 88 -j ACCEPT
-A FORWARD -s 10.84.0.0/20 -d 10.0.2.0/30 -p udp -m udp --dport 88 -j ACCEPT
-A FORWARD -s 10.84.0.0/20 -d 10.0.2.0/30 -p icmp -m icmp --icmp-type any -j ACCEPT
-A FORWARD -s 10.84.0.0/20 -d 10.0.2.0/30 -p udp -m udp --dport 389 -j ACCEPT

5) Конфиг API VPN находится тут: /var/www/Portal_laravel/.env
   Основное ПО с описанием: /var/www/Portal_laravel/app/Http/Controllers/Apicontroller.php
6) Если все параметры из пункта 1 указаны верно - на почту пользователя придет конфиг с инструкцией. Проверить можно с помощью https://portal.site.ru/api/ldaprefresh. Копия письма придет на it@site.ru

